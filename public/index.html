<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebEditX</title>
  <style>
    html, body, #editor { height: 100%; margin: 0; }
    #toolbar { padding: 6px; background: #222; color: #eee; }
    #save-status { margin-left: 12px; }
    button { margin-left: 10px; }
  </style>
  <script src="https://unpkg.com/monaco-editor@0.52.2/min/vs/loader.js"></script>
</head>
<body>
  <div id="toolbar">
    <span id="filename"></span>    
    <button onclick="saveFile()">💾 Save</button>
    <span id="save-status"></span>
  </div>
  <div id="editor"></div>

  <script>
    let editor, currentFile, sessionId = null, hasClosedSession = false;
    let lastSavedValue = "";
    let isSaving = false;

    const SECURITY_COOKIE = "webeditxSecurityAccepted";
    const SECURITY_COOKIE_MAX_AGE_SECONDS = 7 * 24 * 60 * 60;

    function setClientSecurityCookie() {
      document.cookie = `${encodeURIComponent(SECURITY_COOKIE)}=true; path=/; max-age=${SECURITY_COOKIE_MAX_AGE_SECONDS}`;
    }

    function getCookie(name) {
      const prefixed = `${encodeURIComponent(name)}=`;
      const encodedValue = document.cookie
        .split(/; */)
        .find((entry) => entry.startsWith(prefixed))
        ?.slice(prefixed.length);

      return encodedValue ? decodeURIComponent(encodedValue) : undefined;
    }

    async function persistSecurityConsent() {
      try {
        const res = await fetch("/api/security-consent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ accepted: true })
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const payload = await res.json();
        if (!payload?.success) {
          throw new Error("Missing success flag");
        }
      } catch (err) {
        console.warn("Falling back to client-set security cookie:", err);
        setClientSecurityCookie();
      }
    }

    if (!location.host.includes("localhost")) {
      const alreadyAccepted = getCookie(SECURITY_COOKIE) === "true";

      if (!alreadyAccepted) {
        const proceed = confirm(
          `⚠️ Security Warning: Understand the risks before proceeding:

1. Your file data may be readable by the tunnel.
2. Browser extensions and third-party npm scripts might access the data.
3. File data is sent over the internet and could be exposed.
4. There is currently no ideal way to encrypt this data end-to-end here.

Do you want to continue?`
        );

        if (!proceed) {
          throw new Error("User declined due to security risks.");
        }

        persistSecurityConsent();
      }
    }

    require.config({ paths: { vs: "https://unpkg.com/monaco-editor@0.52.2/min/vs" } });
    require(["vs/editor/editor.main"], async () => {
      const res = await fetch("/api/file");
      const { name, content, sessionId: newSessionId } = await res.json();
      document.getElementById("filename").textContent = name;
      updateSaveStatus("saved");
      currentFile = name;
      sessionId = newSessionId;
      editor = monaco.editor.create(document.getElementById("editor"), {
        value: content,
        language: "shell",
        theme: "vs-dark"
      });
      lastSavedValue = content;
      updateSaveStatus("saved");

      editor.onDidChangeModelContent(() => {
        if (!editor) {
          return;
        }

        const hasUnsavedChanges = editor.getValue() !== lastSavedValue;
        updateSaveStatus(hasUnsavedChanges ? "unsaved" : "saved");
      });
    });

    async function saveFile(shouldAlert = true) {
      try {
        const payload = editor.getValue();
        isSaving = true;
        updateSaveStatus("saving");
        const response = await fetch("/api/file", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: payload })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const { success } = await response.json();
        if (!success) {
          throw new Error("Save did not return success flag");
        }

        lastSavedValue = payload;
        updateSaveStatus("saved");

        if (shouldAlert) {
          alert("✅ File saved!");
        }
      } catch (error) {
        console.error("Failed to save file", error);
        updateSaveStatus("unsaved");
        if (shouldAlert) {
          alert("❌ Failed to save file. Check console for details.");
        }
      } finally {
        isSaving = false;
      }
    }

    document.addEventListener("keydown", function (e) {
    // Check for Ctrl+S (or Cmd+S on Mac)
    if ((e.ctrlKey || e.metaKey) && e.key === "s") {
      e.preventDefault(); // Stop browser default "Save Page As..."
      saveFile(); // Call your custom save logic
    }
  });

    function updateSaveStatus(state) {
      if (isSaving && state === "saved" && editor?.getValue() !== lastSavedValue) {
        state = "unsaved";
      }

      const el = document.getElementById("save-status");
      if (!el) {
        return;
      }

      switch (state) {
        case "saving":
          el.textContent = "(Saving...)";
          break;
        case "unsaved":
          el.textContent = "(⚠️ Unsaved changes)";
          break;
        default:
          el.textContent = "";
          break;
      }
    }

    function closeEditor() {
      if (!sessionId || hasClosedSession) {
        return;
      }

      const payload = new Blob([JSON.stringify({ sessionId })], { type: "application/json" });
      const success = navigator.sendBeacon("/api/close-session", payload);

      if (success) {
        hasClosedSession = true;
      }
    }

    window.addEventListener("pagehide", (event) => {
      closeEditor();
      console.log("Page is being closed/unloaded.");
    });

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        console.log("Tab hidden or closed, saving session...");
        closeEditor();
      }
    });
  </script>
</body>

</html>
