<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebEditX</title>
  <style>
    html, body, #editor { height: 100%; margin: 0; }
    #toolbar { padding: 6px; background: #222; color: #eee; }
    button { margin-left: 10px; }
  </style>
  <script src="https://unpkg.com/monaco-editor/min/vs/loader.js"></script>
</head>
<body>
  <div id="toolbar">
    <span id="filename"></span>
    <button onclick="saveFile()">💾 Save</button>
  </div>
  <div id="editor"></div>

  <script>
    let editor, currentFile, sessionId = null, hasClosedSession = false;
    if (!location.host.includes("localhost")) {
  const proceed = confirm(
    `⚠️ Security Warning

Understand the risks before proceeding:

1. Your file data may be readable by the tunnel.
2. Browser extensions and third-party npm scripts might access the data.
3. File data is sent over the internet and could be exposed.
4. There is currently no ideal way to encrypt this data end-to-end here.

Do you want to continue?`
  );

  if (!proceed) {
    throw new Error("User declined due to security risks.");
  }
}

    require.config({ paths: { vs: "https://unpkg.com/monaco-editor/min/vs" } });
    require(["vs/editor/editor.main"], async () => {
      const res = await fetch("/api/file");
      const { name, content, sessionId: newSessionId } = await res.json();
      document.getElementById("filename").textContent = name;
      currentFile = name;
      sessionId = newSessionId;
      editor = monaco.editor.create(document.getElementById("editor"), {
        value: content,
        language: "shell",
        theme: "vs-dark"
      });
    });

    async function saveFile(shouldAlert = true) {
      await fetch("/api/file", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: editor.getValue() })
      });
      if(shouldAlert)
        alert("✅ File saved!");
    }

    document.addEventListener("keydown", function (e) {
    // Check for Ctrl+S (or Cmd+S on Mac)
    if ((e.ctrlKey || e.metaKey) && e.key === "s") {
      e.preventDefault(); // Stop browser default "Save Page As..."
      saveFile(); // Call your custom save logic
    }
  });

    function closeEditor() {
      if (!sessionId || hasClosedSession) {
        return;
      }

      const payload = new Blob([JSON.stringify({ sessionId })], { type: "application/json" });
      const success = navigator.sendBeacon("/api/close-session", payload);

      if (success) {
        hasClosedSession = true;
      }
    }

    window.addEventListener("pagehide", (event) => {
      closeEditor();
      console.log("Page is being closed/unloaded.");
    });

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        console.log("Tab hidden or closed, saving session...");
        closeEditor();
      }
    });
  </script>
</body>

</html>
