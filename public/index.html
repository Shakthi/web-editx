<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WebEditX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --page-bg: #0f172a;
      --surface-bg: #111c35;
      --surface-border: #1e2a45;
      --surface-raised: #152444;
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --accent: #4f46e5;
      --accent-strong: #4338ca;
      --success: #22c55e;
      --warning: #facc15;
      --error: #f87171;
      --radius-md: 14px;
      --radius-pill: 999px;
      --shadow: 0 18px 36px -28px rgba(15, 23, 42, 0.75);
      --font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 0;
      background: var(--page-bg);
      font-family: var(--font-family);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
    }

    .app-shell {
      width: 100%;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: var(--surface-bg);
      border-radius: 0;
      border: none;
      box-shadow: none;
      overflow: hidden;
    }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px clamp(16px, 3vw, 24px);
      background: var(--surface-raised);
      border-bottom: 1px solid var(--surface-border);
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
      flex: 0 1 auto;
    }

    .brand-mark {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: var(--accent);
      font-weight: 600;
      font-size: 0.85rem;
      letter-spacing: 0.06em;
      color: #f8fafc;
      flex-shrink: 0;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .brand-title {
      font-weight: 600;
      font-size: 0.95rem;
      letter-spacing: 0.02em;
    }

    .brand-subtitle {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
    }

    .session-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1 1 auto;
      min-width: 200px;
    }

    .file-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(79, 70, 229, 0.24);
      background: rgba(79, 70, 229, 0.1);
      font-weight: 500;
      font-size: 0.85rem;
      flex: 1 1 auto;
      min-width: 0;
      max-width: none;
      overflow: hidden;
    }

    .file-badge__icon {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 16px;
      height: 16px;
      border-radius: 5px;
      background: rgba(79, 70, 229, 0.22);
      font-size: 0.7rem;
    }

    .file-badge__path {
      display: inline-flex;
      align-items: center;
      font-family: "SFMono-Regular", "Consolas", "Menlo", monospace;
      font-size: 0.8rem;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: var(--radius-pill);
      font-size: 0.8rem;
      font-weight: 500;
      background: rgba(148, 163, 184, 0.16);
      color: var(--text-secondary);
    }

    .status-pill::before {
      content: "";
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: currentColor;
    }

    .status-pill[data-state="saving"] {
      background: rgba(250, 204, 21, 0.16);
      color: var(--warning);
    }

    .status-pill[data-state="unsaved"] {
      background: rgba(250, 204, 21, 0.12);
      color: var(--warning);
    }

    .status-pill[data-state="saved"] {
      background: rgba(34, 197, 94, 0.12);
      color: var(--success);
    }

    .toolbar-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    button {
      border: none;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
      color: #f8fafc;
      font-weight: 600;
      letter-spacing: 0.01em;
      padding: 0 18px;
      height: 36px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: transform 150ms ease, box-shadow 150ms ease, filter 150ms ease;
      box-shadow: 0 10px 20px -14px rgba(79, 70, 229, 0.55);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px -18px rgba(79, 70, 229, 0.7);
    }

    button:active {
      transform: translateY(0);
      filter: brightness(0.96);
    }

    button:disabled {
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
    }

    button[data-state="saving"]::after {
      content: "";
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.6);
      border-top-color: rgba(255, 255, 255, 0.15);
      animation: spin 800ms linear infinite;
    }

    .workspace {
      flex: 1;
      display: flex;
      padding: clamp(12px, 2vw, 20px);
    }

    .editor-card {
      flex: 1;
      display: flex;
      background: rgba(9, 16, 34, 0.96);
      border-radius: 10px;
      border: 1px solid rgba(30, 41, 59, 0.6);
      overflow: hidden;
    }

    #editor {
      width: 100%;
      height: 100%;
    }

    .toast {
      position: fixed;
      bottom: 32px;
      right: 32px;
      min-width: 220px;
      max-width: clamp(220px, 32vw, 320px);
      padding: 14px 18px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(99, 102, 241, 0.28);
      color: var(--text-primary);
      font-weight: 500;
      opacity: 0;
      transform: translateY(16px);
      pointer-events: none;
      transition: opacity 200ms ease, transform 200ms ease;
      box-shadow: 0 18px 32px -24px rgba(8, 15, 40, 0.8);
      z-index: 10;
    }

    .toast[data-type="success"] {
      border-color: rgba(34, 197, 94, 0.3);
      color: #bbf7d0;
    }

    .toast[data-type="error"] {
      border-color: rgba(248, 113, 113, 0.45);
      color: #fecaca;
    }

    .toast--visible {
      opacity: 1;
      transform: translateY(0);
    }

    @media (max-width: 860px) {
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .brand,
      .session-meta,
      .toolbar-actions {
        width: 100%;
      }

      .session-meta,
      .toolbar-actions {
        justify-content: space-between;
      }

      .toolbar-actions button {
        width: 100%;
        justify-content: center;
      }

      .workspace {
        padding: 12px;
      }
    }

    @media (max-width: 520px) {
      body {
        padding: 8px;
      }

      .toast {
        left: 16px;
        right: 16px;
        bottom: 16px;
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
  <script src="https://unpkg.com/monaco-editor@0.52.2/min/vs/loader.js"></script>
</head>
<body>
  <div class="app-shell">
    <header id="toolbar" class="toolbar">
      <div class="brand" aria-label="WebEditX brand">
        <span class="brand-mark" aria-hidden="true">WX</span>
        <div class="brand-text">
          <span class="brand-title">WebEditX</span>
        </div>
      </div>
      <div class="session-meta">
        <div class="file-badge" title="Active file path">
          <span class="file-badge__icon" aria-hidden="true">â–£</span>
          <span id="filename" class="file-badge__path">Loadingâ€¦</span>
        </div>
        <div id="save-status" class="status-pill" data-state="loading">Loadingâ€¦</div>
      </div>
      <div class="toolbar-actions">
        <button id="save-button" type="button" onclick="saveFile()">
          <span aria-hidden="true">ðŸ’¾</span>
          <span>Save</span>
        </button>
      </div>
    </header>
    <main class="workspace">
      <div class="editor-card">
        <div id="editor" role="region" aria-label="Code editor"></div>
      </div>
    </main>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    let editor, currentFile, sessionId = null, hasClosedSession = false;
    let lastSavedValue = "";
    let isSaving = false;
    let toastTimeout;

    const SECURITY_COOKIE = "webeditxSecurityAccepted";
    const SECURITY_COOKIE_MAX_AGE_SECONDS = 7 * 24 * 60 * 60;

    function setClientSecurityCookie() {
      document.cookie = `${encodeURIComponent(SECURITY_COOKIE)}=true; path=/; max-age=${SECURITY_COOKIE_MAX_AGE_SECONDS}`;
    }

    function getCookie(name) {
      const prefixed = `${encodeURIComponent(name)}=`;
      const encodedValue = document.cookie
        .split(/; */)
        .find((entry) => entry.startsWith(prefixed))
        ?.slice(prefixed.length);

      return encodedValue ? decodeURIComponent(encodedValue) : undefined;
    }

    async function persistSecurityConsent() {
      try {
        const res = await fetch("/api/security-consent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ accepted: true })
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const payload = await res.json();
        if (!payload?.success) {
          throw new Error("Missing success flag");
        }
      } catch (err) {
        console.warn("Falling back to client-set security cookie:", err);
        setClientSecurityCookie();
      }
    }

    if (!location.host.includes("localhost")) {
      const alreadyAccepted = getCookie(SECURITY_COOKIE) === "true";

      if (!alreadyAccepted) {
        const proceed = confirm(
          `âš ï¸ Security Warning: Understand the risks before proceeding:\n\n1. Your file data may be readable by the tunnel.\n2. Browser extensions and third-party npm scripts might access the data.\n3. File data is sent over the internet and could be exposed.\n4. There is currently no ideal way to encrypt this data end-to-end here.\n\nDo you want to continue?`
        );

        if (!proceed) {
          throw new Error("User declined due to security risks.");
        }

        persistSecurityConsent();
      }
    }

    require.config({ paths: { vs: "https://unpkg.com/monaco-editor@0.52.2/min/vs" } });
    require(["vs/editor/editor.main"], async () => {
      const res = await fetch("/api/file");
      if (!res.ok) {
         const {error, details} =  await res.json();
         if(details=="Session already exists"){
          setTimeout(() => {
            alert("You are already connected to the file in another tab. Please close tab and start a new session"); 
          }, 600);
           
         }
         return;
      }
      const { name, fullPath, content, sessionId: newSessionId } = await res.json();
      const displayPath = fullPath || name;
      const filenameEl = document.getElementById("filename");
      if (filenameEl) {
        filenameEl.textContent = displayPath;
        filenameEl.setAttribute("title", displayPath);
        filenameEl.parentElement?.setAttribute("title", displayPath);
      }
      document.title = `WebEditX Â· ${displayPath}`;
      currentFile = displayPath;
      sessionId = newSessionId;
      editor = monaco.editor.create(document.getElementById("editor"), {
        value: content,
        language: "shell",
        theme: "vs-dark"
      });
      lastSavedValue = content;
      updateSaveStatus("saved");

      editor.onDidChangeModelContent(() => {
        if (!editor) {
          return;
        }

        const hasUnsavedChanges = editor.getValue() !== lastSavedValue;
        updateSaveStatus(hasUnsavedChanges ? "unsaved" : "saved");
      });
    });

    async function saveFile(shouldNotify = true) {
      if (!editor) {
        if (shouldNotify) {
          showToast("Editor is still loading", "error");
        }
        return;
      }

      try {
        const payload = editor.getValue();
        isSaving = true;
        setSaveButtonBusy(true);
        updateSaveStatus("saving");
        const response = await fetch("/api/file", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: payload })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const { success } = await response.json();
        if (!success) {
          throw new Error("Save did not return success flag");
        }

        lastSavedValue = payload;
        updateSaveStatus("saved");

        if (shouldNotify) {
          showToast("File saved", "success");
        }
      } catch (error) {
        console.error("Failed to save file", error);
        updateSaveStatus("unsaved");
        showToast("Failed to save file", "error");
      } finally {
        isSaving = false;
        setSaveButtonBusy(false);
      }
    }

    document.addEventListener("keydown", function (e) {
      if ((e.ctrlKey || e.metaKey) && e.key === "s") {
        e.preventDefault();
        saveFile(false);
      }
    });

    function setSaveButtonBusy(state) {
      const button = document.getElementById("save-button");
      if (!button) {
        return;
      }

      if (state) {
        button.dataset.state = "saving";
        button.disabled = true;
        button.setAttribute("aria-busy", "true");
      } else {
        button.removeAttribute("data-state");
        button.disabled = false;
        button.removeAttribute("aria-busy");
      }
    }

    function updateSaveStatus(state) {
      if (isSaving && state === "saved" && editor?.getValue() !== lastSavedValue) {
        state = "unsaved";
      }

      const el = document.getElementById("save-status");
      if (!el) {
        return;
      }

      el.dataset.state = state;

      switch (state) {
        case "saving":
          el.textContent = "Savingâ€¦";
          break;
        case "unsaved":
          el.textContent = "Unsaved changes";
          break;
        case "saved":
          el.textContent = "Saved";
          break;
        case "loading":
          el.textContent = "Loadingâ€¦";
          break;
        default:
          el.textContent = "Ready";
          break;
      }
    }

    function showToast(message, type = "info") {
      const toast = document.getElementById("toast");
      if (!toast) {
        return;
      }

      toast.textContent = message;
      if (type === "info") {
        toast.removeAttribute("data-type");
      } else {
        toast.dataset.type = type;
      }
      toast.classList.add("toast--visible");
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toast.classList.remove("toast--visible");
      }, type === "error" ? 5000 : 2400);
    }

    function closeEditor() {
      if (!sessionId || hasClosedSession) {
        return;
      }

      const payload = new Blob([JSON.stringify({ sessionId })], { type: "application/json" });
      const success = navigator.sendBeacon("/api/close-session", payload);

      if (success) {
        hasClosedSession = true;
      }
    }

    window.addEventListener("beforeunload", () => {
      closeEditor();
    });


  </script>
</body>
</html>
